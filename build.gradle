plugins {
  id "eu.appsatori.fatjar" version "0.3"
}

apply plugin: "java"
apply plugin: "eu.appsatori.fatjar"
apply plugin: "eclipse"
apply plugin: "maven"
apply plugin: "signing"

group = "com.github.adamyork"

sourceCompatibility = 1.6
targetCompatibility = 1.6
version = "1.3"

fatJar {
    archiveName = "wiremock-velocity-transformer-standalone-" + fatJar.version + ".jar"
    manifest {
        attributes "Implementation-Title"   : "wiremock-velocity-transformer-standalone",
                   "Implementation-Version" : version
    }
}

task cleanFunctional(type: Delete) {
    delete fileTree(dir: "functional", include: "*-velocity-transformer-*.jar", exclude: "wiremock-1.57-standalone.jar")
}

task copyFunctional(type: Copy) {
     from "build/libs/"
     include "*.jar"
     exclude "*-sources.jar","*-javadoc.jar"
     into "functional/"
}

task javadocJar(type: Jar, dependsOn: javadoc) {
    classifier = "javadoc"
    from "build/docs/javadoc"
}
 
task sourcesJar(type: Jar) {
    from sourceSets.main.allSource
    classifier = "sources"
}

jar {
    dependsOn fatJar
    dependsOn cleanFunctional
    dependsOn copyFunctional
    cleanFunctional.shouldRunAfter fatJar
    copyFunctional.dependsOn cleanFunctional
    copyFunctional.shouldRunAfter jar
    archiveName = "wiremock-velocity-transformer-" + jar.version + ".jar"
    manifest {
        attributes "Implementation-Title"   : "wiremock-velocity-transformer",
                   "Implementation-Version" : version
    }
}

artifacts {
    archives jar
    archives javadocJar
    archives sourcesJar
}

repositories {
    mavenCentral()
}

signing {
    sign configurations.archives
}

dependencies {
    compile         group: "org.apache.velocity",           name: "velocity",             version: "1.7"
    compile         group: "org.apache.velocity",           name: "velocity-tools",       version: "2.0"
    compile         group: "com.github.tomakehurst",        name: "wiremock",             version: "1.57"
    compile         group: "org.mortbay.jetty",             name: "jetty",                version: "6.1.26"
    compile         group: "com.google.guava",              name: "guava",                version: "18.0"
    compile         group: "com.fasterxml.jackson.core",    name: "jackson-core",         version: "2.4.2"
    compile         group: "com.fasterxml.jackson.core",    name: "jackson-annotations",  version: "2.4.2"
    compile         group: "com.fasterxml.jackson.core",    name: "jackson-databind",     version: "2.4.2"
    compile         group: "org.apache.httpcomponents",     name: "httpclient",           version: "4.3.5"
    compile         group: "org.skyscreamer",               name: "jsonassert",           version: "1.2.3"
    compile         group: "xmlunit",                       name: "xmlunit",              version: "1.5"
    compile         group: "com.jayway.jsonpath",           name: "json-path",            version: "0.8.1"
    compile         group: "org.slf4j",                     name: "slf4j-api",            version: "1.7.6"
    compile         group: "net.sf.jopt-simple",            name: "jopt-simple",          version: "4.7"
    compile ("junit:junit:4.11") {
        exclude group: "org.hamcrest", module: "hamcrest-core"
    }    
    testCompile "org.hamcrest:hamcrest-all:1.3"
    testCompile ("org.jmock:jmock:2.5.1") {
        exclude group: "junit", module: "junit-dep"
        exclude group: "org.hamcrest", module: "hamcrest-core"
        exclude group: "org.hamcrest", module: "hamcrest-library"
    }
    testCompile ("org.jmock:jmock-junit4:2.5.1") {
        exclude group: "junit", module: "junit-dep"
        exclude group: "org.hamcrest", module: "hamcrest-core"
        exclude group: "org.hamcrest", module: "hamcrest-library"
    }
    testCompile "net.sf.json-lib:json-lib:2.4:jdk15"
    testCompile "com.googlecode.jarjar:jarjar:1.3"
    testCompile "commons-io:commons-io:2.4"
}

uploadArchives {
    repositories {
        mavenDeployer {

            beforeDeployment { 
                MavenDeployment deployment -> signing.signPom(deployment)
            }
 
            repository(url: "https://oss.sonatype.org/service/local/staging/deploy/maven2/") {
              authentication(userName: sonatypeUsername, password: sonatypePassword)
            }
 
            pom.project {
               name "wiremock-velocity-transformer"
               packaging "jar"
               description "transformer used to render velocity templates for stubbed responses."
               url "https://github.com/adamyork/wiremock-velocity-transformer"
 
               scm {
                   url "scm:git@github.com:adamyork/wiremock-velocity-transformer.git"
                   connection "scm:git@github.com:adamyork/wiremock-velocity-transformer.git"
                   developerConnection "scm:git@github.com:adamyork/wiremock-velocity-transformer.git"
               }
 
               licenses {
                   license {
                       name "The Apache Software License, Version 2.0"
                       url "http://www.apache.org/licenses/LICENSE-2.0.txt"
                       distribution "repo"
                   }
               }
 
               developers {
                   developer {
                       id "adamcyork"
                       name "Adam York"
                   }
               }
           }
        }
    }
}